# Heat Backend

A digital implementation of the **Heat: Pedal to the Metal** racing board game. This backend provides the game engine and API for managing game state, player actions, and turn-based racing mechanics.

## Tech Stack

- **Runtime:** Cloudflare Workers (serverless edge computing)
- **Framework:** [Hono](https://hono.dev/) (lightweight TypeScript web framework)
- **Language:** TypeScript (strict mode)
- **Testing:** Vitest
- **Linting:** Biome

## Getting Started

### Prerequisites

- Node.js 18+
- pnpm (recommended) or npm

### Installation

```bash
pnpm install
```

### Development

```bash
pnpm run dev
```

### Deployment

```bash
pnpm run deploy
```

## Project Structure

```
src/
├── index.ts              # Hono server entry point
└── engine/
    ├── game-engine.ts    # Core game state & turn management
    ├── player.ts         # Player class & card mechanics
    └── *.test.ts         # Test files
```

## Game Mechanics

### Cards

| Type | Description |
|------|-------------|
| **Speed** | Values 1-4, used for movement |
| **Heat** | Generated by the engine, costs of aggressive driving |
| **Stress** | Added based on map difficulty |
| **Upgrade** | Special cards (values 0 and 5) |

### Turn Phases

1. **Shift** - Select a new gear (1-4)
2. **PlayCards** - Play cards from hand equal to current gear
3. **Move** - Move based on played card values
4. **DiscardAndReplenish** - Discard cards and refill hand to 7

### Gear & Shifting

- Gear range: 1-4
- Shift by 1: Free
- Shift by 2: Costs 1 heat card from engine
- Cannot shift more than 2 gears at once

### Track & Corners

Tracks have a length and an array of corners with speed limits:

```typescript
{
  length: 24,
  corners: [
    { position: 6, speedLimit: 4 },
    { position: 15, speedLimit: 3 },
  ]
}
```

When crossing a corner, if your speed (sum of played card values) exceeds the speed limit, you pay heat equal to the difference.

### Stress Card Resolution

When a stress card is played, during movement a replacement card is drawn from the deck:
- Speed/Upgrade cards are added to played cards (contributing to movement)
- Stress/Heat cards go directly to discard

### Spin Out

If you can't pay the full heat penalty at a corner:
- You stop one space before the corner
- Gear resets to 1
- Gain 1 stress card (gear 1-2) or 2 stress cards (gear 3-4)

### Position & Raceline

- Maximum 2 players per track position
- First player to arrive at a position gets the **raceline** (front)
- Second player is off the raceline (back)
- Third+ players cascade back to previous positions
- Turn order: leader (highest position, on raceline) moves first

### Adrenaline

Trailing players receive adrenaline after movement:
- In 2-4 player games: last place gets adrenaline
- In 5+ player games: last 2 places get adrenaline
- Resets at the start of each turn

### Starting Setup (USA Map)

- **Hand:** 7 cards
- **Deck:** 12 speed cards, 2 upgrade cards, 1 heat card, 3 stress cards
- **Engine:** 6 heat cards
- **Track:** Length 24, corners at position 6 (limit 4) and 15 (limit 3)
- **Starting grid:** Players staggered at positions 0, 0, -1, -1, -2... (2 per position)

## Development

### Commands

| Command | Description |
|---------|-------------|
| `pnpm run dev` | Start local development server |
| `pnpm run test` | Run test suite |
| `pnpm run lint` | Run Biome linter with auto-fix |
| `pnpm run cf-typegen` | Generate Cloudflare Worker types |
| `pnpm run deploy` | Deploy to Cloudflare Workers |

### Cloudflare Bindings

When using Cloudflare bindings, pass them as generics:

```ts
const app = new Hono<{ Bindings: CloudflareBindings }>()
```

## Testing

Tests are written with Vitest and cover:

- Player mechanics (draw, shift, play cards, discard, move)
- Stress card resolution during movement
- Corner speed checking and heat penalties
- Spin out mechanics
- Position collision and raceline assignment
- Adrenaline assignment for trailing players
- Game state management and phase transitions
- Input validation and error handling

```bash
pnpm run test
```

## Todo

- [x] Track representation (corners array with position and speedLimit)
- [x] Corner speed limits and heat penalties
- [x] Stress card resolution (draw from deck during movement)
- [x] Spin out mechanics
- [x] Position collision (max 2 per position, raceline)
- [x] Turn order based on race position
- [x] Adrenaline for trailing players
- [ ] Slipstream/drafting mechanics
- [ ] Win condition and lap tracking
- [ ] REST API endpoints
- [ ] Game persistence

## License

MIT
