# Heat Backend

A digital implementation of the **Heat: Pedal to the Metal** racing board game. This backend provides the game engine and API for managing game state, player actions, and turn-based racing mechanics.

## Tech Stack

- **Runtime:** Cloudflare Workers (serverless edge computing)
- **Framework:** [Hono](https://hono.dev/) (lightweight TypeScript web framework)
- **Language:** TypeScript (strict mode)
- **Testing:** Vitest
- **Linting:** Biome

## Getting Started

### Prerequisites

- Node.js 18+
- pnpm (recommended) or npm

### Installation

```bash
pnpm install
```

### Development

```bash
pnpm run dev
```

### Deployment

**Deploy Backend (Cloudflare Workers):**
```bash
cd packages/backend
pnpm run deploy
```

**Deploy Frontend (Cloudflare Pages):**
```bash
cd packages/frontend
pnpm run build
npx wrangler pages deploy dist --project-name=heat-frontend
```

**Deploy Both:**
```bash
# From root
pnpm --filter backend run deploy
cd packages/frontend && pnpm run build && npx wrangler pages deploy dist --project-name=heat-frontend
```

## Project Structure

```
packages/
├── backend/              # Cloudflare Workers backend
│   └── src/
│       ├── index.ts      # Hono server entry point
│       ├── game-room.ts  # Room logic (pure business logic)
│       ├── game-room-do.ts # Durable Object wrapper
│       ├── lobby.ts      # Lobby Durable Object
│       └── engine/
│           ├── game.ts   # Core game state & turn management
│           ├── player.ts # Player class & card mechanics
│           └── *.test.ts # Test files
└── frontend/             # React frontend (Cloudflare Pages)
    └── src/
        ├── components/   # React components
        ├── hooks/        # Custom hooks (WebSocket)
        └── types.ts      # Shared types
```

## Game Mechanics

### Cards

| Type | Description |
|------|-------------|
| **Speed** | Values 1-4, used for movement |
| **Heat** | Generated by the engine, costs of aggressive driving |
| **Stress** | Added based on map difficulty |
| **Upgrade** | Special cards (values 0 and 5) |

### Turn Phases

**Planning Phase** (all players simultaneously):
1. **Plan** - Select gear (1-4) and play cards from hand equal to gear

**Resolution Phase** (in race order, leader first):
1. **Reveal & Move** - Reveal cards, resolve stress, calculate movement
2. **Adrenaline** - Trailing players may accept +1 move and/or +1 cooldown
3. **React** - Use cooldown (move heat from hand to engine) or boost
4. **Slipstream** - If adjacent to another car, may draft +2 spaces
5. **Check Corner** - Pay heat for exceeding corner speed limits
6. **Check Collision** - Resolve position conflicts (max 2 per space)
7. **Discard & Replenish** - Discard cards, refill hand to 7

### Gear & Shifting

- Gear range: 1-4
- Shift by 1: Free
- Shift by 2: Costs 1 heat card from engine
- Cannot shift more than 2 gears at once

### Track & Corners

Tracks have a length and an array of corners with speed limits:

```typescript
{
  length: 24,
  corners: [
    { position: 6, speedLimit: 4 },
    { position: 15, speedLimit: 3 },
  ]
}
```

When crossing a corner, if your speed (sum of played card values) exceeds the speed limit, you pay heat equal to the difference.

### Stress Card Resolution

When a stress card is played, during movement a replacement card is drawn from the deck:
- Speed/Upgrade cards are added to played cards (contributing to movement)
- Stress/Heat cards go directly to discard

### Spin Out

If you can't pay the full heat penalty at a corner:
- You stop one space before the corner
- Gear resets to 1
- Gain 1 stress card (gear 1-2) or 2 stress cards (gear 3-4)

### Position & Raceline

- Maximum 2 players per track position
- First player to arrive at a position gets the **raceline** (front)
- Second player is off the raceline (back)
- Third+ players cascade back to previous positions
- Turn order: leader (highest position, on raceline) moves first

### Slipstream

After reacting, if you are at the same position or 1 space behind another car, you may slipstream:
- Gain +2 spaces instantly
- Does not count toward corner speed (only card speed + adrenaline counts)

### Adrenaline

Trailing players receive adrenaline at the end of each turn:
- In 2-4 player games: last place gets adrenaline
- In 5+ player games: last 2 places get adrenaline

Adrenaline grants two optional bonuses during resolution:
- **+1 Move** - Added to card speed (counts toward corner penalties)
- **+1 Cooldown** - Extra cooldown reaction available

### Starting Setup (USA Map)

- **Hand:** 7 cards
- **Deck:** 12 speed cards, 2 upgrade cards, 1 heat card, 3 stress cards
- **Engine:** 6 heat cards
- **Track:** Length 24, corners at position 6 (limit 4) and 15 (limit 3)
- **Starting grid:** Players staggered at positions 0, 0, -1, -1, -2... (2 per position)

## Development

### Commands

| Command | Description |
|---------|-------------|
| `pnpm run dev` | Start both backend and frontend dev servers |
| `pnpm run dev:backend` | Start backend dev server only |
| `pnpm run dev:frontend` | Start frontend dev server only |
| `pnpm run test` | Run backend test suite |
| `pnpm run verify` | Run linter and tests |
| `pnpm --filter backend deploy` | Deploy backend to Cloudflare Workers |

### Cloudflare Bindings

When using Cloudflare bindings, pass them as generics:

```ts
const app = new Hono<{ Bindings: CloudflareBindings }>()
```

## Testing

Tests are written with Vitest and cover:

- Player mechanics (draw, shift, play cards, discard, move)
- Stress card resolution during movement
- Corner speed checking and heat penalties
- Spin out mechanics
- Position collision and raceline assignment
- Adrenaline assignment for trailing players
- Game state management and phase transitions
- Input validation and error handling

```bash
pnpm run test
```

## Todo

- [x] Track representation (corners array with position and speedLimit)
- [x] Corner speed limits and heat penalties
- [x] Stress card resolution (draw from deck during movement)
- [x] Spin out mechanics
- [x] Position collision (max 2 per position, raceline)
- [x] Turn order based on race position
- [x] Adrenaline for trailing players
- [x] Slipstream/drafting mechanics
- [ ] Boost reaction
- [ ] Win condition and lap tracking
- [ ] REST API endpoints
- [ ] Game persistence

## License

MIT
